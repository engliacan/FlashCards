<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="apple-mobile-web-app-title" content="FlashCard Study" />
  <meta name="theme-color" content="#6c5ce7" />
  <title>FlashCard Study</title>
  <link rel="manifest" href="./manifest.json" />
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
    :root {
      --bg: #0a0a0f; --surface: #141420; --surface-light: #1e1e30;
      --accent: #6c5ce7; --accent-glow: rgba(108,92,231,0.3);
      --correct: #00b894; --correct-glow: rgba(0,184,148,0.25);
      --wrong: #e17055; --wrong-glow: rgba(225,112,85,0.25);
      --text: #f0f0f5; --text-muted: #8888aa; --border: #2a2a40;
    }
    body {
      font-family: 'DM Sans', 'Avenir', sans-serif;
      background: linear-gradient(170deg, var(--bg) 0%, #0d0d1a 50%, #12101f 100%);
      color: var(--text);
      min-height: 100vh; min-height: 100dvh;
      max-width: 430px; margin: 0 auto;
      user-select: none; -webkit-user-select: none;
      overflow-x: hidden;
    }
    button { font-family: inherit; cursor: pointer; }
    .header { padding: 56px 24px 16px; text-align: center; }
    .header h1 {
      font-size: 28px; font-weight: 800; letter-spacing: -0.5px;
      background: linear-gradient(135deg, #f0f0f5, #6c5ce7);
      -webkit-background-clip: text; -webkit-text-fill-color: transparent;
    }
    .header p { font-size: 13px; color: var(--text-muted); margin-top: 4px; letter-spacing: 0.5px; }
    .content { padding: 0 24px; }
    .spacer { height: 40px; }
    input[type="file"] { display: none; }

    .upload-area {
      border: 2px dashed var(--border); border-radius: 20px;
      padding: 36px 24px; text-align: center; cursor: pointer;
      background: rgba(20,20,32,0.6); backdrop-filter: blur(10px);
      transition: all 0.3s ease;
    }
    .upload-area.dragging { border-color: var(--accent); background: var(--accent-glow); }
    .upload-area .icon { font-size: 40px; margin-bottom: 12px; }
    .upload-area .label { font-size: 16px; font-weight: 600; margin-bottom: 6px; }
    .upload-area .hint { font-size: 12px; color: var(--text-muted); line-height: 1.5; }
    .upload-btn-small {
      margin-top: 14px; padding: 10px 24px; background: var(--accent);
      border-radius: 12px; display: inline-block; font-weight: 600; font-size: 14px;
      color: var(--text); border: none;
    }
    .error-msg {
      margin-top: 16px; padding: 12px 16px; background: var(--wrong-glow);
      border-radius: 12px; font-size: 13px; color: var(--wrong); text-align: center;
    }

    .section-title {
      font-size: 11px; font-weight: 700; margin: 28px 0 12px;
      color: var(--text-muted); letter-spacing: 0.5px; text-transform: uppercase;
    }
    .deck-card {
      background: var(--surface); border: 1px solid var(--border);
      border-radius: 16px; padding: 16px; margin-bottom: 10px;
      display: flex; align-items: center; justify-content: space-between;
      transition: all 0.2s; cursor: pointer;
    }
    .deck-card:active { background: var(--surface-light); }
    .deck-info { flex: 1; min-width: 0; }
    .deck-name { font-size: 15px; font-weight: 600; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .deck-meta { font-size: 12px; color: var(--text-muted); margin-top: 3px; }
    .deck-stats-mini { display: flex; gap: 8px; margin-top: 5px; }
    .deck-stats-mini span { font-size: 11px; font-weight: 600; padding: 2px 8px; border-radius: 6px; }
    .deck-remove {
      width: 32px; height: 32px; border-radius: 10px; border: 1px solid var(--border);
      background: transparent; color: var(--text-muted); font-size: 14px;
      display: flex; align-items: center; justify-content: center; transition: all 0.2s;
      margin-left: 12px; flex-shrink: 0;
    }
    .deck-remove:active { background: var(--wrong-glow); color: var(--wrong); border-color: rgba(225,112,85,0.3); }

    .deck-header { text-align: center; padding: 20px 0 24px; }
    .deck-header h2 { font-size: 20px; font-weight: 700; margin-bottom: 4px; word-break: break-word; }
    .deck-header p { font-size: 13px; color: var(--text-muted); }
    .detail-btn {
      width: 100%; padding: 16px; border-radius: 14px; font-weight: 700; font-size: 15px;
      margin-bottom: 10px; cursor: pointer; transition: all 0.2s;
    }
    .btn-new-session { border: none; background: linear-gradient(135deg, var(--accent), #8b7cf7); color: #fff; }
    .btn-history { border: 1px solid var(--border); background: var(--surface); color: var(--text); font-weight: 600; }
    .btn-back-subtle {
      border: none; background: transparent; color: var(--text-muted);
      font-weight: 500; font-size: 14px; width: 100%; padding: 12px; cursor: pointer;
    }

    .history-item {
      background: var(--surface); border: 1px solid var(--border);
      border-radius: 14px; padding: 14px 16px; margin-bottom: 8px;
    }
    .history-date { font-size: 12px; color: var(--text-muted); margin-bottom: 6px; }
    .history-stats { display: flex; gap: 12px; }
    .history-stats span { font-size: 13px; font-weight: 600; }
    .history-stats .h-correct { color: var(--correct); }
    .history-stats .h-wrong { color: var(--wrong); }
    .history-stats .h-pct { color: var(--accent); }
    .empty-history { text-align: center; padding: 40px 0; color: var(--text-muted); font-size: 14px; }

    .progress-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
    .progress-header .back { background: none; border: none; color: var(--text-muted); font-size: 14px; padding: 0; }
    .progress-header .stats { font-size: 12px; color: var(--text-muted); }
    .progress-bar { height: 4px; background: var(--border); border-radius: 2px; overflow: hidden; margin-bottom: 16px; }
    .progress-fill { height: 100%; border-radius: 2px; transition: width 0.4s ease; background: linear-gradient(90deg, var(--accent), var(--correct)); }
    .filters { display: flex; gap: 8px; margin-bottom: 20px; }
    .filters button {
      flex: 1; padding: 8px 0; border-radius: 10px;
      border: 1px solid var(--border); background: transparent;
      color: var(--text-muted); font-size: 12px; font-weight: 600; transition: all 0.2s;
    }
    .filters button.active { border-color: var(--accent); background: var(--accent-glow); color: var(--text); }
    .card-counter { text-align: center; margin-bottom: 12px; font-size: 13px; color: var(--text-muted); }
    .status-badge { margin-left: 8px; padding: 2px 8px; border-radius: 6px; font-size: 11px; font-weight: 600; }
    .status-badge.correct { background: var(--correct-glow); color: var(--correct); }
    .status-badge.wrong { background: var(--wrong-glow); color: var(--wrong); }

    .card-wrapper { perspective: 1000px; height: 320px; cursor: pointer; margin-bottom: 20px; }
    .card-inner {
      position: relative; width: 100%; height: 100%;
      transition: transform 0.5s cubic-bezier(0.4,0,0.2,1);
      transform-style: preserve-3d;
    }
    .card-inner.flipped { transform: rotateY(180deg); }
    .card-face {
      position: absolute; width: 100%; height: 100%;
      backface-visibility: hidden; border-radius: 24px;
      display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 28px;
    }
    .card-front {
      background: linear-gradient(145deg, var(--surface-light), var(--surface));
      border: 1px solid var(--border);
      box-shadow: 0 8px 32px rgba(0,0,0,0.3), inset 0 1px 0 rgba(255,255,255,0.05);
    }
    .card-back {
      transform: rotateY(180deg);
      background: linear-gradient(145deg, #1a1a35, #151528);
      border: 1px solid rgba(108,92,231,0.25);
      box-shadow: 0 8px 32px rgba(0,0,0,0.3), 0 0 40px var(--accent-glow);
    }
    .card-label { font-size: 11px; font-weight: 600; letter-spacing: 1.5px; text-transform: uppercase; margin-bottom: 16px; }
    .card-label.question { color: var(--accent); }
    .card-label.answer { color: var(--correct); }
    .card-text { font-size: 20px; font-weight: 600; text-align: center; line-height: 1.4; overflow-y: auto; max-height: 200px; width: 100%; }
    .card-hint { position: absolute; bottom: 20px; font-size: 12px; color: var(--text-muted); }

    .actions { display: flex; gap: 12px; margin-bottom: 16px; }
    .actions button { flex: 1; padding: 16px; border-radius: 14px; font-weight: 700; font-size: 16px; transition: all 0.15s; }
    .btn-wrong { border: 1px solid rgba(225,112,85,0.3); background: transparent; color: var(--wrong); }
    .btn-wrong:active, .btn-wrong.active { background: var(--wrong-glow); }
    .btn-correct { border: 1px solid rgba(0,184,148,0.3); background: transparent; color: var(--correct); }
    .btn-correct:active, .btn-correct.active { background: var(--correct-glow); }

    .nav-buttons { display: flex; gap: 12px; }
    .nav-buttons button {
      flex: 1; padding: 14px; border-radius: 14px;
      border: 1px solid var(--border); background: var(--surface);
      color: var(--text); font-weight: 600; font-size: 15px;
    }
    .btn-finish {
      width: 100%; margin-top: 12px; padding: 16px; border-radius: 14px; border: none;
      background: linear-gradient(135deg, var(--accent), #8b7cf7);
      color: #fff; font-weight: 700; font-size: 15px;
    }

    .stat-boxes { display: flex; gap: 12px; margin-bottom: 24px; }
    .stat-box { flex: 1; padding: 18px 12px; border-radius: 16px; text-align: center; }
    .stat-box .value { font-size: 28px; font-weight: 800; }
    .stat-box .label { font-size: 11px; color: var(--text-muted); margin-top: 4px; font-weight: 600; letter-spacing: 0.5px; }
    .stat-correct { background: var(--correct-glow); border: 1px solid rgba(0,184,148,0.2); }
    .stat-correct .value { color: var(--correct); }
    .stat-wrong { background: var(--wrong-glow); border: 1px solid rgba(225,112,85,0.2); }
    .stat-wrong .value { color: var(--wrong); }
    .stat-total { background: var(--accent-glow); border: 1px solid rgba(108,92,231,0.2); }
    .stat-total .value { color: var(--accent); }

    .summary-header { text-align: center; padding: 40px 0; }
    .summary-header .emoji { font-size: 56px; margin-bottom: 16px; }
    .summary-header h2 { font-size: 22px; font-weight: 700; margin-bottom: 8px; }
    .summary-header p { font-size: 14px; color: var(--text-muted); }
    .summary-btn { width: 100%; padding: 16px; border-radius: 14px; font-weight: 700; font-size: 15px; margin-bottom: 12px; cursor: pointer; }
    .btn-review-wrong { border: 1px solid rgba(225,112,85,0.25); background: var(--wrong-glow); color: var(--wrong); }
    .btn-start-over { border: 1px solid var(--border); background: var(--surface); color: var(--text); font-weight: 600; }
    .btn-new-file { border: none; background: transparent; color: var(--text-muted); font-weight: 500; font-size: 14px; }

    .confirm-overlay {
      position: fixed; top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.7); display: flex; align-items: center; justify-content: center;
      z-index: 100; padding: 24px;
    }
    .confirm-box {
      background: var(--surface-light); border: 1px solid var(--border);
      border-radius: 20px; padding: 24px; max-width: 320px; width: 100%; text-align: center;
    }
    .confirm-box h3 { font-size: 17px; font-weight: 700; margin-bottom: 8px; }
    .confirm-box p { font-size: 13px; color: var(--text-muted); margin-bottom: 20px; line-height: 1.5; }
    .confirm-btns { display: flex; gap: 10px; }
    .confirm-btns button { flex: 1; padding: 12px; border-radius: 12px; font-weight: 600; font-size: 14px; }
    .confirm-cancel { border: 1px solid var(--border); background: transparent; color: var(--text); }
    .confirm-delete { border: none; background: var(--wrong); color: #fff; }
  </style>
</head>
<body>

<div class="header">
  <h1>FlashCard Study</h1>
  <p id="subtitle">STUDY SMARTER, NOT HARDER</p>
</div>
<div class="content" id="app"></div>
<div class="spacer"></div>

<script>
const app = document.getElementById('app');
const subtitle = document.getElementById('subtitle');
const STORAGE_KEY = 'flashcard_study_data';

// ‚îÄ‚îÄ‚îÄ Storage ‚îÄ‚îÄ‚îÄ
function loadData() {
  try { return JSON.parse(localStorage.getItem(STORAGE_KEY)) || { decks: [] }; }
  catch { return { decks: [] }; }
}
function saveData(data) {
  try { localStorage.setItem(STORAGE_KEY, JSON.stringify(data)); } catch {}
}
function saveDeck(name, cardCount) {
  const data = loadData();
  const existing = data.decks.find(d => d.name === name);
  if (!existing) {
    data.decks.unshift({ name, cardCount, sessions: [], lastUsed: Date.now() });
  } else {
    existing.lastUsed = Date.now();
    existing.cardCount = cardCount;
    data.decks = [existing, ...data.decks.filter(d => d.name !== name)];
  }
  saveData(data);
}
function saveSession(deckName, correct, wrong, total) {
  const data = loadData();
  const deck = data.decks.find(d => d.name === deckName);
  if (deck) {
    deck.sessions.unshift({ date: Date.now(), correct, wrong, total, pct: Math.round((correct / total) * 100) });
    deck.lastUsed = Date.now();
    if (deck.sessions.length > 50) deck.sessions = deck.sessions.slice(0, 50);
    saveData(data);
  }
}
function removeDeck(deckName) {
  const data = loadData();
  data.decks = data.decks.filter(d => d.name !== deckName);
  saveData(data);
}

// ‚îÄ‚îÄ‚îÄ State ‚îÄ‚îÄ‚îÄ
let cards = [];
let fileName = '';
let currentIndex = 0;
let flipped = false;
let filter = 'all';
let sessionSaved = false;

function getFiltered() {
  if (filter === 'unmarked') return cards.filter(c => c.status === null);
  if (filter === 'wrong') return cards.filter(c => c.status === 'wrong');
  return [...cards];
}
function countBy(s) { return cards.filter(c => c.status === s).length; }
function escHtml(s) { const d = document.createElement('div'); d.textContent = s; return d.innerHTML; }

function formatDate(ts) {
  const d = new Date(ts);
  return d.toLocaleDateString('default', { month: 'short', day: 'numeric', year: 'numeric' })
    + ' at ' + d.toLocaleTimeString('default', { hour: 'numeric', minute: '2-digit' });
}
function formatDateShort(ts) {
  const diff = Date.now() - ts;
  if (diff < 60000) return 'Just now';
  if (diff < 3600000) return `${Math.floor(diff/60000)}m ago`;
  if (diff < 86400000) return `${Math.floor(diff/3600000)}h ago`;
  if (diff < 604800000) return `${Math.floor(diff/86400000)}d ago`;
  return new Date(ts).toLocaleDateString('default', { month: 'short', day: 'numeric' });
}

// ‚îÄ‚îÄ‚îÄ Confirm Dialog ‚îÄ‚îÄ‚îÄ
function showConfirm(title, message, onConfirm) {
  const overlay = document.createElement('div');
  overlay.className = 'confirm-overlay';
  overlay.innerHTML = `
    <div class="confirm-box">
      <h3>${title}</h3>
      <p>${message}</p>
      <div class="confirm-btns">
        <button class="confirm-cancel" id="confirmCancel">Cancel</button>
        <button class="confirm-delete" id="confirmOk">Remove</button>
      </div>
    </div>`;
  document.body.appendChild(overlay);
  document.getElementById('confirmCancel').addEventListener('click', () => overlay.remove());
  document.getElementById('confirmOk').addEventListener('click', () => { overlay.remove(); onConfirm(); });
  overlay.addEventListener('click', e => { if (e.target === overlay) overlay.remove(); });
}

// ‚îÄ‚îÄ‚îÄ Home Screen ‚îÄ‚îÄ‚îÄ
function showHome() {
  cards = []; fileName = ''; currentIndex = 0; flipped = false; filter = 'all'; sessionSaved = false;
  subtitle.textContent = 'STUDY SMARTER, NOT HARDER';
  const data = loadData();

  const decksHtml = data.decks.map(d => {
    const last = d.sessions && d.sessions[0];
    let statsHtml = '';
    if (last) {
      statsHtml = `<div class="deck-stats-mini">
        <span style="background:var(--correct-glow);color:var(--correct)">‚úì ${last.correct}</span>
        <span style="background:var(--wrong-glow);color:var(--wrong)">‚úó ${last.wrong}</span>
        <span style="background:var(--accent-glow);color:var(--accent)">${last.pct}%</span>
      </div>`;
    }
    return `<div class="deck-card" data-deck="${escHtml(d.name)}">
      <div class="deck-info">
        <div class="deck-name">${escHtml(d.name)}</div>
        <div class="deck-meta">${d.cardCount} cards ¬∑ ${d.sessions ? d.sessions.length : 0} sessions ¬∑ ${formatDateShort(d.lastUsed)}</div>
        ${statsHtml}
      </div>
      <button class="deck-remove" data-remove="${escHtml(d.name)}" title="Remove">‚úï</button>
    </div>`;
  }).join('');

  app.innerHTML = `
    <div class="upload-area" id="dropZone">
      <div class="icon">üìÑ</div>
      <div class="label">Upload New Flashcards</div>
      <div class="hint">Excel or CSV ¬∑ Column A = Questions ¬∑ Column B = Answers</div>
      <button class="upload-btn-small">Choose File</button>
      <input type="file" id="fileInput" accept=".xlsx,.xls,.csv" />
    </div>
    <div id="errorMsg"></div>
    ${data.decks.length > 0 ? `<div class="section-title">Recent Decks</div>${decksHtml}` : `
      <div style="margin-top:32px;padding:20px;background:var(--surface);border-radius:16px;border:1px solid var(--border)">
        <div style="font-size:14px;font-weight:600;margin-bottom:10px">How it works</div>
        <div style="font-size:13px;color:var(--text-muted);line-height:1.7">
          1. Upload your spreadsheet with Q&A pairs<br>
          2. Tap a card to reveal the answer<br>
          3. Mark each card as correct ‚úì or wrong ‚úó<br>
          4. Track your progress over time
        </div>
      </div>`}`;

  const dropZone = document.getElementById('dropZone');
  const fileInput = document.getElementById('fileInput');
  dropZone.addEventListener('click', () => fileInput.click());
  dropZone.addEventListener('dragover', e => { e.preventDefault(); dropZone.classList.add('dragging'); });
  dropZone.addEventListener('dragleave', () => dropZone.classList.remove('dragging'));
  dropZone.addEventListener('drop', e => { e.preventDefault(); dropZone.classList.remove('dragging'); processFile(e.dataTransfer.files[0]); });
  fileInput.addEventListener('change', e => processFile(e.target.files[0]));

  document.querySelectorAll('.deck-card').forEach(el => {
    el.addEventListener('click', e => {
      if (e.target.closest('.deck-remove')) return;
      showDeckDetail(el.dataset.deck);
    });
  });
  document.querySelectorAll('.deck-remove').forEach(btn => {
    btn.addEventListener('click', e => {
      e.stopPropagation();
      const name = btn.dataset.remove;
      showConfirm('Remove Deck?', `"${name}" and all its session history will be removed.`, () => { removeDeck(name); showHome(); });
    });
  });
}

function showError(msg) {
  const el = document.getElementById('errorMsg');
  if (el) el.innerHTML = msg ? `<div class="error-msg">${msg}</div>` : '';
}

function processFile(file, afterLoad) {
  if (!file) return;
  showError && showError('');
  const ext = file.name.split('.').pop().toLowerCase();
  if (!['xlsx','xls','csv'].includes(ext)) { showError && showError('Please upload an Excel (.xlsx, .xls) or CSV file.'); return; }

  const reader = new FileReader();
  if (ext === 'csv') {
    reader.onload = e => {
      const result = Papa.parse(e.target.result, { header: false, skipEmptyLines: true });
      const parsed = result.data.filter(r => r[0] && r[1]).map((r,i) => ({ id: i, question: r[0].trim(), answer: r[1].trim(), status: null }));
      if (!parsed.length) { showError && showError('No valid Q&A pairs found.'); return; }
      cards = parsed;
      if (afterLoad) afterLoad(file.name);
      else { fileName = file.name; saveDeck(fileName, cards.length); showDeckDetail(fileName); }
    };
    reader.readAsText(file);
  } else {
    reader.onload = e => {
      try {
        const wb = XLSX.read(new Uint8Array(e.target.result), { type: 'array' });
        const ws = wb.Sheets[wb.SheetNames[0]];
        const data = XLSX.utils.sheet_to_json(ws, { header: 1 });
        const parsed = data.filter(r => r[0] && r[1]).map((r,i) => ({ id: i, question: String(r[0]).trim(), answer: String(r[1]).trim(), status: null }));
        if (!parsed.length) { showError && showError('No valid Q&A pairs found.'); return; }
        cards = parsed;
        if (afterLoad) afterLoad(file.name);
        else { fileName = file.name; saveDeck(fileName, cards.length); showDeckDetail(fileName); }
      } catch { showError && showError('Error reading file.'); }
    };
    reader.readAsArrayBuffer(file);
  }
}

// ‚îÄ‚îÄ‚îÄ Deck Detail ‚îÄ‚îÄ‚îÄ
function showDeckDetail(deckName) {
  fileName = deckName;
  sessionSaved = false;
  const data = loadData();
  const deck = data.decks.find(d => d.name === deckName);
  const sessionCount = deck ? deck.sessions.length : 0;
  const cardCount = deck ? deck.cardCount : (cards.length || '?');
  subtitle.textContent = deckName;

  let bestHtml = '';
  if (deck && deck.sessions.length > 0) {
    const best = deck.sessions.reduce((a, b) => a.pct > b.pct ? a : b);
    bestHtml = `<div style="display:flex;gap:12px;margin-bottom:20px">
      <div class="stat-box stat-correct" style="flex:1"><div class="value">${best.pct}%</div><div class="label">BEST SCORE</div></div>
      <div class="stat-box stat-total" style="flex:1"><div class="value">${sessionCount}</div><div class="label">SESSIONS</div></div>
      <div class="stat-box" style="flex:1;background:var(--surface);border:1px solid var(--border)"><div class="value" style="color:var(--text)">${cardCount}</div><div class="label">CARDS</div></div>
    </div>`;
  }

  const needsFile = cards.length === 0;

  app.innerHTML = `
    <div class="deck-header">
      <h2>${escHtml(deckName)}</h2>
      <p>${cardCount} cards ¬∑ ${sessionCount} session${sessionCount !== 1 ? 's' : ''}</p>
    </div>
    ${bestHtml}
    ${needsFile ? `
      <div style="padding:16px;background:var(--accent-glow);border-radius:14px;margin-bottom:16px;text-align:center">
        <div style="font-size:13px;color:var(--text);line-height:1.5">Upload <strong>${escHtml(deckName)}</strong> to start a new session.</div>
        <button class="upload-btn-small" style="margin-top:12px" id="reuploadBtn">Choose File</button>
        <input type="file" id="reuploadInput" accept=".xlsx,.xls,.csv" />
      </div>` : `
      <button class="detail-btn btn-new-session" id="newSessionBtn">‚ñ∂ New Study Session</button>`}
    <button class="detail-btn btn-history" id="historyBtn">üìä Session History (${sessionCount})</button>
    <button class="btn-back-subtle" id="backHomeBtn">‚Üê Back to Home</button>`;

  if (needsFile) {
    const reupBtn = document.getElementById('reuploadBtn');
    const reupInput = document.getElementById('reuploadInput');
    reupBtn.addEventListener('click', () => reupInput.click());
    reupInput.addEventListener('change', e => {
      processFile(e.target.files[0], (name) => {
        fileName = deckName;
        saveDeck(deckName, cards.length);
        showDeckDetail(deckName);
      });
    });
  } else {
    document.getElementById('newSessionBtn').addEventListener('click', startStudy);
  }
  document.getElementById('historyBtn').addEventListener('click', () => showHistory(deckName));
  document.getElementById('backHomeBtn').addEventListener('click', showHome);
}

// ‚îÄ‚îÄ‚îÄ History ‚îÄ‚îÄ‚îÄ
function showHistory(deckName) {
  const data = loadData();
  const deck = data.decks.find(d => d.name === deckName);
  const sessions = deck ? deck.sessions : [];
  subtitle.textContent = `${deckName} ¬∑ History`;

  let listHtml = sessions.length === 0
    ? '<div class="empty-history">No sessions yet. Start studying to see your progress here!</div>'
    : sessions.map(s => `<div class="history-item">
        <div class="history-date">${formatDate(s.date)}</div>
        <div class="history-stats">
          <span class="h-correct">‚úì ${s.correct} correct</span>
          <span class="h-wrong">‚úó ${s.wrong} wrong</span>
          <span class="h-pct">${s.pct}% score</span>
        </div>
      </div>`).join('');

  app.innerHTML = `
    <div class="deck-header"><h2>üìä Session History</h2>
      <p>${escHtml(deckName)} ¬∑ ${sessions.length} session${sessions.length !== 1 ? 's' : ''}</p>
    </div>
    ${listHtml}
    <button class="btn-back-subtle" id="backDetailBtn">‚Üê Back to Deck</button>`;

  document.getElementById('backDetailBtn').addEventListener('click', () => showDeckDetail(deckName));
}

// ‚îÄ‚îÄ‚îÄ Study ‚îÄ‚îÄ‚îÄ
function startStudy() {
  currentIndex = 0; flipped = false; filter = 'all'; sessionSaved = false;
  cards = cards.map(c => ({ ...c, status: null }));
  subtitle.textContent = `${fileName} ¬∑ ${cards.length} cards`;
  renderStudy();
}

function renderStudy() {
  const filtered = getFiltered();
  const correct = countBy('correct');
  const wrong = countBy('wrong');
  const unmarked = countBy(null);
  const progress = ((cards.length - unmarked) / cards.length) * 100;

  if (filtered.length === 0) { showSummary(); return; }
  if (currentIndex >= filtered.length) currentIndex = filtered.length - 1;
  if (currentIndex < 0) currentIndex = 0;
  const card = filtered[currentIndex];

  let statusBadge = '';
  if (card.status === 'correct') statusBadge = '<span class="status-badge correct">‚úì Correct</span>';
  else if (card.status === 'wrong') statusBadge = '<span class="status-badge wrong">‚úó Wrong</span>';

  app.innerHTML = `
    <div class="progress-header">
      <button class="back" id="backBtn">‚Üê Back</button>
      <span class="stats">${correct}‚úì ¬∑ ${wrong}‚úó ¬∑ ${unmarked} left</span>
    </div>
    <div class="progress-bar"><div class="progress-fill" style="width:${progress}%"></div></div>
    <div class="filters">
      <button class="${filter==='all'?'active':''}" data-f="all">All (${cards.length})</button>
      <button class="${filter==='unmarked'?'active':''}" data-f="unmarked">Unmarked (${unmarked})</button>
      <button class="${filter==='wrong'?'active':''}" data-f="wrong">Wrong (${wrong})</button>
    </div>
    <div class="card-counter">${currentIndex+1} of ${filtered.length} ${statusBadge}</div>
    <div class="card-wrapper" id="cardFlip">
      <div class="card-inner ${flipped?'flipped':''}">
        <div class="card-face card-front">
          <div class="card-label question">Question</div>
          <div class="card-text">${escHtml(card.question)}</div>
          <div class="card-hint">Tap to reveal answer</div>
        </div>
        <div class="card-face card-back">
          <div class="card-label answer">Answer</div>
          <div class="card-text">${escHtml(card.answer)}</div>
        </div>
      </div>
    </div>
    ${flipped ? `<div class="actions">
      <button class="btn-wrong ${card.status==='wrong'?'active':''}" id="markWrong">‚úó Wrong</button>
      <button class="btn-correct ${card.status==='correct'?'active':''}" id="markCorrect">‚úì Correct</button>
    </div>` : ''}
    <div class="nav-buttons">
      <button id="prevBtn">‚óÄ Prev</button>
      <button id="nextBtn">Next ‚ñ∂</button>
    </div>
    ${unmarked === 0 && filter === 'all' ? '<button class="btn-finish" id="finishBtn">View Results üéØ</button>' : ''}`;

  document.getElementById('backBtn').addEventListener('click', () => showDeckDetail(fileName));
  document.getElementById('cardFlip').addEventListener('click', () => { flipped = !flipped; renderStudy(); });
  document.querySelectorAll('.filters button').forEach(b => {
    b.addEventListener('click', () => { filter = b.dataset.f; currentIndex = 0; flipped = false; renderStudy(); });
  });
  if (flipped) {
    document.getElementById('markWrong').addEventListener('click', () => markCard(card.id, 'wrong'));
    document.getElementById('markCorrect').addEventListener('click', () => markCard(card.id, 'correct'));
  }
  document.getElementById('prevBtn').addEventListener('click', () => navigate(-1));
  document.getElementById('nextBtn').addEventListener('click', () => navigate(1));
  const finishBtn = document.getElementById('finishBtn');
  if (finishBtn) finishBtn.addEventListener('click', showSummary);
}

function markCard(id, status) {
  cards = cards.map(c => c.id === id ? { ...c, status } : c);
  flipped = false;
  const filtered = getFiltered();

  if (filtered.length === 0) { showSummary(); return; }

  if (filter === 'unmarked') {
    if (currentIndex >= filtered.length) currentIndex = filtered.length - 1;
  } else {
    const next = currentIndex + 1;
    if (next >= filtered.length) {
      if (countBy(null) === 0 && filter === 'all') { showSummary(); return; }
      currentIndex = 0;
    } else {
      currentIndex = next;
    }
  }
  renderStudy();
}

function navigate(dir) {
  const filtered = getFiltered();
  flipped = false;
  currentIndex += dir;
  if (currentIndex < 0) currentIndex = filtered.length - 1;
  if (currentIndex >= filtered.length) currentIndex = 0;
  renderStudy();
}

// ‚îÄ‚îÄ‚îÄ Summary ‚îÄ‚îÄ‚îÄ
function showSummary() {
  const correct = countBy('correct');
  const wrong = countBy('wrong');
  const total = cards.length;

  if (!sessionSaved) {
    saveSession(fileName, correct, wrong, total);
    sessionSaved = true;
  }

  app.innerHTML = `
    <div class="summary-header">
      <div class="emoji">üéâ</div>
      <h2>${filter==='wrong' ? 'Reviewed All Missed Cards!' : 'All Cards Reviewed!'}</h2>
      <p>Here's how you did</p>
    </div>
    <div class="stat-boxes">
      <div class="stat-box stat-correct"><div class="value">${correct}</div><div class="label">CORRECT</div></div>
      <div class="stat-box stat-wrong"><div class="value">${wrong}</div><div class="label">WRONG</div></div>
      <div class="stat-box stat-total"><div class="value">${total}</div><div class="label">TOTAL</div></div>
    </div>
    ${wrong > 0 ? `<button class="summary-btn btn-review-wrong" id="reviewWrong">üîÑ Review Wrong Answers (${wrong})</button>` : ''}
    <button class="summary-btn btn-start-over" id="startOver">‚Üª Start Over</button>
    <button class="summary-btn btn-new-file" id="backHome">‚Üê Back to Home</button>`;

  if (wrong > 0) {
    document.getElementById('reviewWrong').addEventListener('click', () => {
      filter = 'wrong'; currentIndex = 0; flipped = false; renderStudy();
    });
  }
  document.getElementById('startOver').addEventListener('click', () => {
    cards = cards.map(c => ({ ...c, status: null }));
    filter = 'all'; currentIndex = 0; flipped = false; sessionSaved = false; renderStudy();
  });
  document.getElementById('backHome').addEventListener('click', showHome);
}

showHome();

// Register service worker for offline support
if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => {
    navigator.serviceWorker.register('./sw.js').then(reg => {
      console.log('SW registered:', reg.scope);
    }).catch(err => {
      console.log('SW registration failed:', err);
    });
  });
}
</script>
</body>
</html>
